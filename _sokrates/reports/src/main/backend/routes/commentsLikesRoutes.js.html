<html>
<head>
    <title>backend/routes/commentsLikesRoutes.js</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 40px;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>
<body style="font-family: 'DejaVu Sans', Arial, Helvetica, sans-serif">
<h3 style="margin-bottom: 0">backend/routes/commentsLikesRoutes.js (<b>83</b> lines of code) (<a href="commentsLikesRoutes.js">raw</a>):</h3>
<div id="editor">const express = require(&quot;express&quot;);
const router = express.Router();
const supabase = require(&quot;../supabaseClient&quot;);

// Get all comments for a specific idea
router.get(&quot;/comments/:idee_id&quot;, async (req, res) =&gt; {
  const { idee_id } = req.params;

  try {
    const { data, error } = await supabase
      .from(&quot;comments&quot;)
      .select(&quot;*&quot;)
      .eq(&quot;idee_id&quot;, idee_id)
      .order(&quot;created_at&quot;, { ascending: true });

    if (error) throw error;

    res.status(200).json(data);
  } catch (err) {
    console.error(&quot;‚ùå Error fetching comments:&quot;, err.message);
    res.status(500).json({ error: &quot;Failed to fetch comments&quot; });
  }
});

// Add a comment (temporary: user_id = 1)
router.post(&quot;/comments&quot;, async (req, res) =&gt; {
  const { idee_id, content } = req.body;

  const user_id = 1; // **************************placeholder until auth is ready

  if (!idee_id || !content) {
    return res.status(400).json({ error: &quot;Missing required fields&quot; });
  }

  try {
    const { data, error } = await supabase
      .from(&quot;comments&quot;)
      .insert([{ idee_id, user_id, content }])
      .select();

    if (error) throw error;

    res.status(201).json(data[0]);
  } catch (err) {
    console.error(&quot;Error adding comment:&quot;, err.message);
    res.status(500).json({ error: &quot;Failed to add comment&quot; });
  }
});

//  Get total likes for an idea
router.get(&quot;/likes/:idee_id&quot;, async (req, res) =&gt; {
  const { idee_id } = req.params;

  try {
    const { count, error } = await supabase
      .from(&quot;likes&quot;)
      .select(&quot;*&quot;, { count: &quot;exact&quot;, head: true })
      .eq(&quot;idee_id&quot;, idee_id);

    if (error) throw error;

    res.status(200).json({ likes: count });
  } catch (err) {
    console.error(&quot;‚ùå Error fetching likes:&quot;, err.message);
    res.status(500).json({ error: &quot;Failed to fetch likes&quot; });
  }
});

//  Toggle like (temporary: user_id = 1)
router.post(&quot;/likes/:idee_id&quot;, async (req, res) =&gt; {
  const { idee_id } = req.params;
  const user_id = 1; // üëà temporary placeholder

  try {
    // Check if the user already liked this idea
    const { data: existing, error: fetchError } = await supabase
      .from(&quot;likes&quot;)
      .select(&quot;*&quot;)
      .eq(&quot;idee_id&quot;, idee_id)
      .eq(&quot;user_id&quot;, user_id)
      .single();

    if (fetchError &amp;&amp; fetchError.code !== &quot;PGRST116&quot;) throw fetchError;

    if (existing) {
      // Unlike &rarr; delete the record
      const { error: deleteError } = await supabase
        .from(&quot;likes&quot;)
        .delete()
        .eq(&quot;idee_id&quot;, idee_id)
        .eq(&quot;user_id&quot;, user_id);

      if (deleteError) throw deleteError;

      return res.status(200).json({ message: &quot;Like removed&quot; });
    } else {
      // Like &rarr; insert new record
      const { data, error } = await supabase
        .from(&quot;likes&quot;)
        .insert([{ idee_id, user_id }])
        .select();

      if (error) throw error;

      return res.status(201).json({ message: &quot;Like added&quot;, data });
    }
  } catch (err) {
    console.error(&quot; Error toggling like:&quot;, err.message);
    res.status(500).json({ error: &quot;Failed to toggle like&quot; });
  }
});

module.exports = router;
</div>
<script src="https://www.zeljkoobrenovic.com/tools/common/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.session.setMode("ace/mode/javascript");
    editor.setTheme("ace/theme/xcode");
    editor.setReadOnly(true);
    editor.setOption("wrap", true);
    editor.setPrintMarginColumn(120);
</script>
</body>
